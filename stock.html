<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Prompt&display=swap');
body {
  font-family:"Prompt",sans-serif;
  background:#f4f6f9;
  margin:5px;
}
.container {
  max-width:100%;
  margin:auto;
  background:#fff;
  padding:15px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
h1 {
  text-align:center;
  color:#333;
  font-size:22px;
  margin-bottom:10px;
}
.btn {
  padding:10px 12px;
  border:none;
  background:#1976d2;
  color:#fff;
  border-radius:50px;
  cursor:pointer;
  margin:3px;
  font-size:14px;
  display:inline-block;
  min-width:50px;
}
.btn:hover { background:#125aa0; }

.table-wrapper {
  overflow-x:auto;
  margin-top:10px;
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th, td {
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
  font-size:13px;
}
th {
  background:#1976d2;
  color:white;
  font-size:14px;
}
input[type="text"], input[type="number"], select {
  width:100%;
  text-align:center;
  font-size:13px;
  padding:6px;
  border:1px solid #ccc;
  border-radius:6px;
  box-sizing:border-box;
}
.low { background:#ffcccc; }
#reader { width:100%; margin:10px auto; display:none; }

/* ‚úÖ Responsive Table ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
@media (max-width: 768px) {
  table, thead, tbody, th, td, tr {
    display: block;
  }
  thead tr {
    display: none;
  }
  tbody tr {
    margin-bottom: 15px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 10px 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }
  td {
    text-align: left;
    border: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    font-size: 15px;
    border-bottom: 1px solid #eee;
  }
  td:last-child {
    border-bottom: none;
  }
  td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #1976d2;
    flex: 1;
    min-width: 120px;
  }
  td input, td select {
    flex: 1.2;
    text-align: center;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 6px;
    max-width: 160px;
  }
}

/* ‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
@media (max-width: 600px) {
  .btn {
    display:block;
    width:100%;
    margin:6px 0;
    font-size:15px;
  }
}

@media print {
  body * { visibility:hidden; }
  #printArea, #printArea * { visibility:visible; }
  #printArea { position:absolute; left:0; top:0; width:100%; }
}
</style>
</head>

<body>
<div class="container">
<h1>üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>

<div style="text-align:center;">
  <button class="btn" onclick="window.location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
  <button class="btn" id="start-scan">‡∏™‡πÅ‡∏Å‡∏ôüì∏</button>
  <button class="btn" id="addItemBtn">‡πÄ‡∏û‡∏¥‡πà‡∏°‚ûï</button>
  <button class="btn" id="saveBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Åüíæ</button>
  <button class="btn" id="clearBtn" style="background:#e53935;">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•üßπ</button>
  <button class="btn" id="export">ExcelüìÅ</button>
  <button class="btn" id="pdfBtn">PDFüìÑ</button>
  <button class="btn" id="printBtn">‡∏û‡∏¥‡∏°‡∏û‡πåüñ®Ô∏è</button>
</div>

<div id="reader"></div>

<div class="table-wrapper">
<table id="stockTable">
  <thead>
    <tr>
      <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤</th>
      <th>‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</th>
      <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
      <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
      <th>‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</th>
      <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>
</div>

<div id="printArea" style="display:none;">
<h2 style="text-align:center;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
<table style="width:100%; border-collapse:collapse;">
  <thead>
    <tr>
      <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤</th>
      <th>‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</th>
      <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
      <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
      <th>‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</th>
    </tr>
  </thead>
  <tbody id="printTable"></tbody>
</table>
</div>

<script>
let items = JSON.parse(localStorage.getItem("stockItems")) || [];
const units = ["‡∏•‡∏±‡∏á","‡∏°‡πâ‡∏ß‡∏ô","‡∏Å‡∏•‡πà‡∏≠‡∏á","‡∏î‡∏≠‡∏Å","‡πÉ‡∏ö","‡∏ï‡∏±‡∏ß","‡∏≠‡∏±‡∏ô","‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å","‡∏ñ‡∏∏‡∏á"];

function saveItems(){ localStorage.setItem("stockItems", JSON.stringify(items)); }

function renderTable(){
  const tbody = document.querySelector("#stockTable tbody");
  tbody.innerHTML="";
  items.forEach((item,index)=>{
    const inQty = parseInt(item.inQty)||0;
    const outQty = parseInt(item.outQty)||0;
    const remain = inQty - outQty;
    const order = remain<=10?"‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°":"";
    const rowClass = remain<=10?"low":"";
    const row = document.createElement("tr");
    row.className=rowClass;

    let unitOptions = units.map(u=>`<option value="${u}" ${u===item.unit?'selected':''}>${u}</option>`).join("");

    row.innerHTML=`
      <td data-label="‡∏•‡∏≥‡∏î‡∏±‡∏ö">${index+1}</td>
      <td data-label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">${item.date}</td>
      <td data-label="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå"><input type="text" value="${item.name}" onchange="updateItem(${index},'name',this.value)"></td>
      <td data-label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤"><input type="number" value="${item.inQty}" onchange="updateItem(${index},'inQty',this.value)"></td>
      <td data-label="‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å"><input type="number" value="${item.outQty}" onchange="updateItem(${index},'outQty',this.value)"></td>
      <td data-label="‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠">${remain}</td>
      <td data-label="‡∏´‡∏ô‡πà‡∏ß‡∏¢"><select onchange="updateItem(${index},'unit',this.value)">${unitOptions}</select></td>
      <td data-label="‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°">${order}</td>
      <td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"><button class="btn" style="background:#e53935" onclick="deleteItem(${index})">‚ùå</button></td>
    `;
    tbody.appendChild(row);
  });
}

function updateItem(i,key,value){ items[i][key]=value; saveItems(); renderTable(); }
function addItem(){
  const name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:"); if(!name)return;
  const inQty = prompt("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤:","0");
  const outQty = prompt("‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å:","0");
  const unit = prompt(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${units.join(",")}`,units[0]);
  const date = new Date().toLocaleDateString("th-TH");
  items.push({date,name,inQty,outQty,unit});
  saveItems(); renderTable();
}
function deleteItem(i){ if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){ items.splice(i,1); saveItems(); renderTable(); } }

document.getElementById("addItemBtn").addEventListener("click",addItem);
document.getElementById("saveBtn").addEventListener("click",()=>{ saveItems(); alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); });
document.getElementById("clearBtn").addEventListener("click",()=>{
  if(confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){
    items = [];
    saveItems();
    renderTable();
  }
});

// Export Excel
document.getElementById("export").addEventListener("click",()=>{
  const ws=XLSX.utils.table_to_sheet(document.getElementById("stockTable"));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Stock");
  XLSX.writeFile(wb,"stock_items.xlsx");
});

// Print
document.getElementById("printBtn").addEventListener("click",()=>{
  const printTbody=document.getElementById("printTable");
  printTbody.innerHTML="";
  items.forEach((item,index)=>{
    const inQty=parseInt(item.inQty)||0;
    const outQty=parseInt(item.outQty)||0;
    const remain=inQty-outQty;
    const order = remain<=10?"‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°":"";
    const row=document.createElement("tr");
    row.innerHTML=`<td>${index+1}</td><td>${item.date}</td><td>${item.name}</td><td>${inQty}</td><td>${outQty}</td><td>${remain}</td><td>${item.unit||''}</td><td>${order}</td>`;
    printTbody.appendChild(row);
  });
  document.getElementById("printArea").style.display="block";
  window.print();
  document.getElementById("printArea").style.display="none";
});

// ‚úÖ PDF ‡∏™‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏£‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
document.getElementById("pdfBtn").addEventListener("click", ()=>{
  import("https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js").then(({ jsPDF })=>{
    import("https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js").then(()=>{
      const doc = new jsPDF('p', 'mm', 'a4');
      doc.setFont("THSarabun", "normal");
      doc.setFontSize(16);
      doc.text("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", 105, 15, {align:"center"});
      doc.setFontSize(12);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      const headers = [["‡∏•‡∏≥‡∏î‡∏±‡∏ö","‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà","‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤","‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å","‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠","‡∏´‡∏ô‡πà‡∏ß‡∏¢","‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°"]];

      // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      const body = items.map((item, index) => {
        const inQty = parseInt(item.inQty) || 0;
        const outQty = parseInt(item.outQty) || 0;
        const remain = inQty - outQty;
        const order = remain <= 10 ? "‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°" : "";
        return [
          index + 1,
          item.date,
          item.name,
          inQty,
          outQty,
          remain,
          item.unit || "",
          order
        ];
      });

      // ‡πÉ‡∏ä‡πâ autoTable ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö PDF
      doc.autoTable({
        head: headers,
        body: body,
        startY: 25,
        styles: {
          fontSize: 11,
          halign: "center",
          valign: "middle",
          cellPadding: 2,
          lineColor: [200, 200, 200],
          lineWidth: 0.2
        },
        headStyles: {
          fillColor: [25, 118, 210],
          textColor: 255,
          fontStyle: 'bold'
        },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        columnStyles: {
          2: { halign: "left", cellWidth: 40 },
          3: { cellWidth: 18 },
          4: { cellWidth: 18 },
          5: { cellWidth: 18 },
          6: { cellWidth: 18 },
          7: { cellWidth: 25 }
        },
        margin: { left: 10, right: 10 }
      });

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå
      doc.save("stock_items.pdf");
    });
  });
});

// ‡∏™‡πÅ‡∏Å‡∏ô QR (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á)
const html5QrCode = new Html5Qrcode("reader");
document.getElementById("start-scan").addEventListener("click", async ()=>{
  document.getElementById("reader").style.display="block";
  try {
    const cameras = await Html5Qrcode.getCameras();
    if(!cameras.length) throw "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á";
    const backCam = cameras.find(c=>/back|rear|‡∏´‡∏•‡∏±‡∏á/i.test(c.label)) || cameras[cameras.length-1];
    await html5QrCode.start(
      {deviceId:{exact:backCam.id}},
      {fps:10, qrbox:250},
      decodedText=>{
        const itemName = decodedText.trim();
        const date = new Date().toLocaleDateString("th-TH");
        const existingIndex = items.findIndex(i=>i.name===itemName);
        if(existingIndex>=0){
          const inQty = prompt(`‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ${itemName} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°: ${items[existingIndex].inQty}\n‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô:`, items[existingIndex].inQty);
          const outQty = prompt(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏°: ${items[existingIndex].outQty}\n‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô:`, items[existingIndex].outQty);
          const unit = prompt(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${units.join(",")}`, items[existingIndex].unit||units[0]);
          items[existingIndex] = {date,name:itemName,inQty,outQty,unit};
        }else{
          const inQty = prompt("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤:","0");
          const outQty = prompt("‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å:","0");
          const unit = prompt(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${units.join(",")}`,units[0]);
          items.push({date,name:itemName,inQty,outQty,unit});
        }
        saveItems(); renderTable();
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: "+itemName);
        html5QrCode.stop(); document.getElementById("reader").style.display="none";
      }
    );
  } catch(err){
    alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: "+err);
  }
});

renderTable();
</script>
</body>
</html>
